# Hackthebox - Intro to Android Exploitation - Track

- Requires a VIP account to access the retired box and challenges
- For this track you will need a setup for Android App Hacking. You can see how to set this up [here](../mobile-app/android.md)

## Challenge - Pinned

![Pinned](../.res/2023-01-20-14-43-53.png)  

- Here is the readme

```txt
1. Install this application in an API Level 29 or earlier (i.e. Android 10.0 (Google APIs)).
```

- For this challenge we need to bypass certificate pinning.

- Take frida server from [here](https://github.com/frida/frida/releases)
- `unxz frida-server-version-android-x86.xz` to decompress the file
- `mkdir frida-on-venv` In my opt folder, I created a new folder for frida.
- `sudo python3 -m venv frida` Create the virtual env for frida
- `source frida/bin/activate` Activate the env
- `pip3 install frida-tools` Install Frida
- Install the apk file in your virtual machine (you can drag and drop it)
- Launch it and keep it on screen
- `adb push frida-server-16.0.8-android-x86 /data/local/tmp/frida-server`
- `adb root` (it should be already rooted but just for sanity)
- `adb shell "chmod 755 /data/local/tmp/frida-server"` so that you can launch it ;)
- In another terminal tab `adb shell` to drop in your android shell
- `su`
- `/data/local/tmp/frida-server &` to launch frida-server  

![launch frida-server](../.res/2023-01-20-14-20-07.png)  

- `frida-ps -U -ai` from your host (will list the process) you should see pinned in the list  

![Pinned process detailed](../.res/2023-01-07-14-31-39.png)  

- Take [this script](https://raw.githubusercontent.com/httptoolkit/frida-android-unpinning/main/frida-script.js)  `wget https://raw.githubusercontent.com/httptoolkit/frida-android-unpinning/main/frida-script.js`
- Then you just need to run `frida -U -l ./frida-script.js -f com.example.pinned`  

![spawned](../.res/2023-01-07-14-32-47.png)  

- Now we should be able to intercept the traffic and actually see it in Burp (frida server should still be running for this process)
- Click login in your screen  

![Pinned](../.res/2023-01-19-19-07-46.png)  

- And we got the flag from Burp  

![Flag](../.res/2023-01-19-19-08-40.png)

## Challenge - Manager

![Manager](../.res/2023-01-20-14-44-31.png)  

- Here is the readme

```txt

```

- We need to exactly the same process as we did for Pinned and bypass cert pining.
- For it to work I used Android 7 API 25  

![Android 7](../.res/2023-01-20-14-28-09.png)  

- You should now be able to intercept the traffic.
- Connect to the instance you started
- Create an account
- When I logged in with my account I saw there was this role parameter that looked interesting  

![login](../.res/2023-01-20-14-30-21.png)  

- I tried to register a member with an admin role but without success. However I tried admin and got this error `Username already taken!`

![new admin](../.res/2023-01-20-14-31-42.png)  

- So we know that there is a user admin.
- And after some exploration I saw that to change the password it just need a username and a password.
- So why not try to change the password for the admin user  

![change password](../.res/2023-01-20-14-33-10.png)  

- It works!  
- We can now login as admin and we get the flag

![flag](../.res/2023-01-20-14-34-12.png)  

## Challenge Anchored

![Anchored](../.res/2023-01-20-14-45-42.png)

- Here is the readme

```txt
1. Install this application in an API Level 29 or earlier (i.e. Android 10.0 (Google Play)).

2. Install this application in a non-rooted device (i.e. In Android Studio AVD Manager select an image that includes (Google Play)).
```

- So for the other challenged I used Genymotion, but for this one I am going to use android studio (with burp and all the necessary setup)
- It seems like we will need to bypass cert pining without root rights
- So we have a non-rooted Android 10 VM  

![Non rooted Android 10](../.res/2023-01-20-15-18-58.png)  

- In order to do this we need objection and objection needs clean version of apktool (not the one that has `-dirty` in the end)

```bash
$ apktool --version
2.7.0
```

- Now we need to patch the apk `objection patchapk -s ~/Documents/kali-shared/hackthebox/Anchored/Anchored/Anchored.apk`

```bash
$ objection patchapk -s Anchored.apk 
No architecture specified. Determining it using `adb`...
Detected target device architecture as: x86
Using latest Github gadget version: 16.0.8
Patcher will be using Gadget version: 16.0.8
Detected apktool version as: 2.7.0
Running apktool empty-framework-dir...
I: Removing 1.apk framework file...
Unpacking Anchored.apk
App already has android.permission.INTERNET
Target class not specified, searching for launchable activity instead...
Reading smali from: /tmp/tmpfr2zcaji.apktemp/smali/com/example/anchored/MainActivity.smali
Injecting into an existing constructor
Injecting loadLibrary call at line: 18
Attempting to fix the constructors .locals count
Current locals value is 1, updating to 2:
Writing patched smali back to: /tmp/tmpfr2zcaji.apktemp/smali/com/example/anchored/MainActivity.smali
Copying Frida gadget to libs path...
Rebuilding the APK with the frida-gadget loaded...
Built new APK with injected loadLibrary and frida-gadget
Performing zipalign
Zipalign completed
Signing new APK.
Signed the new APK
Copying final apk from /tmp/tmpfr2zcaji.apktemp.aligned.objection.apk to Anchored.objection.apk in current directory...
Cleaning up temp files
```

- After this we get a version of the apk with objection in the name `Anchored.objection.apk`
- We can install it in our VM `adb install Anchored.objection.apk`
- We can lauch it. The app will be frozen (it's normal)
- `objection explore`
- And now we have to disable ssl pinning `android sslpinning disable`  

![disable ssl pinning](../.res/2023-01-20-16-22-49.png)  

- It will launch the screen and you will see the traffic in burp
- Here is the app we can try to enter a random email and request access  

![Anchored](../.res/2023-01-20-16-24-48.png)  

- And we get the flag (do not forget to put it in `HTB{}` before submitting it)  

![flag](../.res/2023-01-20-16-25-38.png)  

## Challenge APKrypt

![APKrypt](../.res/2023-01-20-16-32-17.png)  

- Here is the readme

```bash
1. Install this application in an API Level 29 or earlier (i.e. Android 10.0 (Google APIs)).
```

[](We have to bypass the cert as we did previously same process as Pinned)

- Let's have a look at the code `./jadx-gui` 