# API Tests

## Make a lab for API pentest

- I made this using the [course on API Sec by Corey Ball](https://university.apisec.ai/) I really recommend that you check it out if not already.

-  Install a kali VM
  - Update it

```
sudo apt update -y
sudo apt upgrade -y
sudo apt dist-upgrade -y
```

- Install Burp Suite (its best if you can have a pro version)
  - Get the latest jython jar and install and specify the path in burp
  - Install Autorize from the store

- Install foxy proxy in firefox
- Set up burp certificate
- Set up MITMweb certificate
  - quit burpsuite if open
  - set foxyproxy on port 8080
  - get the certificate from mitm.it and install it

- Install postman `sudo wget https://dl.pstmn.io/download/latest/linux64 -O postman-linux-x64.tar.gz && sudo tar -xvzf postman-linux-x64.tar.gz -C /opt && sudo ln -s /opt/Postman/Postman /usr/bin/postman`
(check for the dl link of the latest version and adapt the previous command)

- Install mitmproxy2swagger `sudo pip3 install mitmproxy2swagger`

- Install git if necessary

- Install Docker `sudo apt-get install docker.io docker-compose`

- Install Go `sudo apt install golang-go`

- Set up the JSON Web Token Toolkit

```
git clone https://github.com/ticarpi/jwt_tool
cd jwt_tool
python3 -m pip install termcolor cprint pycryptodomex requests
(Optional) Make an alias for jwt_tool.py
sudo chmod +x jwt_tool.py
sudo ln -s /opt/jwt_tool/jwt_tool.py /usr/bin/jwt_tool
```

- Install Kiterunner (see more info below)

- Install Arjun `sudo git clone https://github.com/s0md3v/Arjun.git`

- Install Owasp Zap if necessary `sudo apt install zaproxy` update the Add-Ons

## Misc tips

- With an API we need to check as many endpoints as possible sometimes an endpoint will be protected but another will not have the same protection.
- A great methodology to use is the one made by [David Sopas - MindAPI](https://dsopas.github.io/MindAPI/play/)
- To not forget also to try to enumerate id if for instance you have http://api/user/ try to put 1 in the end you might get user enumeration this way
- When interactig with json in burpsuite repeater if we find an endpoint we have to add the content type like this in the headers `Content-Type: application/json`

## Kiterunner

- We can fetch the latest release [here](https://github.com/assetnote/kiterunner) or follow the guide if we want to build the binary.
  - Large routes list in kite fetchable [here](https://wordlists-cdn.assetnote.io/data/kiterunner/routes-large.kite.tar.gz)
  - Small routes list in kite fetchable[here](https://wordlists-cdn.assetnote.io/data/kiterunner/routes-small.kite.tar.gz)

```
sudo git clone  https://github.com/assetnote/kiterunner.git
cd kiterunner
sudo make build
sudo ln -s /opt/kiterunner/dist/kr /usr/bin/kr
```

- Useful commands:
  - Basic scan: `kr scan https://<ip>/ -w routes-large.kite`
  - Pass the Bearer token (to avoid getting too many 403): `sudo ./kr scan https://<IP>/ -w routes-small.kite -H 'Authorization: Bearer TOKEN-HERE'`
  - We can specify in the url /api/vX if we have it but kiterunner can also find it for us with the basic scan.
    Alissa Knight's whitepaper explains this very well: *"By default, when depth isn’t specified, Kiterunner will scan a target at 1 level deep, meaning if you specified a target of server.com, Kiterunner would scan server.com/api. At level 2, it would scan server.com/api/R4 and at level 3, it would scan server.com/api/R4/patient."*
  - To send to Burp Suite append the command with: `--proxy=http://127.0.0.1:8080` (this is done with replay not with scan)

## RESTler

*"RESTler, developed at Microsoft, is the world’s first stateful API fuzzer that automatically generates tests and automatic execution by first reading the OpenAPI specification in order to automatically find vulnerabilities in the API."*

- Fetch it [here](https://github.com/microsoft/restler-fuzzer)
- *"If you receive a nuget error NU1403 when building, a quick workaround is to clear your cache with this command: $ dotnet nuget locals all--clear"*
- Quite a pain to install on kali.

## wfuzz

This tool will allow to enumerate methods for API which is really convenient. It is preinstalled on kali.
- `wfuzz -X METHOD -w /path/to/wordlist -u http://URL/FUZZ` where you see `FUZZ` it will replace with words from the wordlist and as for `METHOD` you can use GET POST and any other http verb
- if you add the option `--hc ` you can hide specific codes like 404 for instance `--hc 404,405`
- To pass a header in wfuzz (Say Authorization for instance) you can use `-H "myheader: headervalue"` you can use multiple header this way
- Check out this [doc](https://wfuzz.readthedocs.io/en/latest/user/basicusage.html) for more infor on this tool

## Convert Postman to OpenApi

- You can convert them using [Postman to OpenApi](https://github.com/joolfe/postman-to-openapi)
- `sudo apt install npm ` Install nmp if you do not have it
- `sudo npm i postman-to-openapi -g ` install postman to openapi cli mode
- `p2o myfile.postman_collection.json -f myfile.yml` convert your first file

## About response codes

- Do not neglect 400 codes, they can help you identify actual endpoint. For example 404 is not found but 401 is unauthorized.
- However be also aware that: 
  - Sometimes you will get unauthorized on every endpoint meaning that this theory won't work ;)
  - Sometimes waf will drop your requests or will give you a 200 with an error page

## Postman

### Setting up baseurl

To give the base url variable a valid value, select the root of the collection  
And on the middle panel select variables. Add your host in the current value (for instance https://myhost.com), select the url and select Set as variable.  
It should look like this:  
![Set as variable](../.res/current-value.png)  
Set the proper authorization, configure postman with burp (if you do not know how check out Hakluke and Farah Hawa article in the resources below), and you should be able to send requests

### Bearer Token

If you use a bearer token and do not want to set up authentication, you can just add a current token in the Authozization tab or the collection's root.
**Important: Do not forget to Save your changes because it wont work if you don't**  
After this you just have to set the other to inherit auth from parent and you should be good to go.

## Tools

{% embed url="https://www.postman.com/downloads/" %} Postman {% endembed %}
{% embed url="https://github.com/assetnote/kiterunner" %} Kiterunner {% endembed %}

## Resources

{% embed url="https://university.apisec.ai/" %} APISEC University by Corey Ball {% endembed %}  
{% embed url="https://github.com/hAPI-hacker/Hacking-APIs" %} Hacking-APIs Wordlist {% endembed %}  
{% embed url="https://dsopas.github.io/MindAPI/play/" %} MINDApi by David Sopas {% endembed %}  
{% embed url="https://labs.detectify.com/2021/08/31/go-fuzz-yourself-how-to-find-more-vulnerabilities-in-apis-through-fuzzing-whitepaper-download/?utm_source=referral&utm_medium=referral&utm_campaign=alissaknight" %} Go fuzz yourself - How to find more vulnerabilities through fuzzing - Alissa Knight {% endembed %}
{% embed url="https://labs.detectify.com/2021/08/10/how-to-hack-apis-in-2021/" %} How to hack APIs in 2021 - Hakluke and Farah Hawa {% endembed %}
{% embed url="https://www.secureideas.com/blog/2019/03/better-api-penetration-testing-with-postman-part-1.html" %} Better API testing with postman - Mic Whitehorn-Gillam - Part 1 {% endembed %}
{% embed url="https://www.secureideas.com/blog/2019/03/better-api-penetration-testing-with-postman-part-2.html" %} Better API testing with postman - Mic Whitehorn-Gillam - Part 2 {% endembed %}
{% embed url="https://www.secureideas.com/blog/2019/04/better-api-penetration-testing-with-postman-part-3.html" %} Better API testing with postman - Mic Whitehorn-Gillam - Part 3 {% endembed %}
{% embed url="https://www.secureideas.com/blog/2019/06/better-api-penetration-testing-with-postman-part-4.html" %} Better API testing with postman - Mic Whitehorn-Gillam - Part 4 {% endembed %}
{% embed url="https://blog.shiftleft.io/api-security-101-11fafcc4ba35" %} API Security 101 - Vickie Lee {% endembed %}  
{% embed url="https://danaepp.com/7-essential-burp-extensions-for-hacking-apis" %}7 Essential Burp Extensions for Hacking APIs - Dana Epp{% endembed %}
